# AllinONE æ•°æ®åº“åº“å­˜æ–¹æ¡ˆéƒ¨ç½²æŒ‡å—

## æ–¹æ¡ˆæ¦‚è¿°
å°†åº“å­˜æ•°æ®ä»æµè§ˆå™¨ localStorage è¿ç§»åˆ° PostgreSQL æ•°æ®åº“ï¼Œå®ç°è·¨è®¾å¤‡åŒæ­¥å’Œæ•°æ®æŒä¹…åŒ–ã€‚

---

## éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œæ•°æ®åº“è„šæœ¬

1. è¿æ¥åˆ°ä½ çš„ PostgreSQL æ•°æ®åº“
2. æ‰§è¡Œ SQL è„šæœ¬ï¼š

```bash
psql -d allinone_db -f database-schema-inventory.sql
```

æˆ–ç›´æ¥åœ¨æ•°æ®åº“ç®¡ç†å·¥å…·ä¸­æ‰§è¡Œ `database-schema-inventory.sql`

**åˆ›å»ºçš„è¡¨ï¼š**
- `cross_game_inventory` - è·¨æ¸¸æˆåº“å­˜ä¸»è¡¨
- `inventory_sync_log` - åŒæ­¥æ—¥å¿—è¡¨
- `user_inventory_summary` - åº“å­˜æ±‡æ€»è§†å›¾

---

### ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²åç«¯ API

1. å°† `src/server/api/inventory.ts` æ·»åŠ åˆ°ä½ çš„ Express åç«¯é¡¹ç›®
2. åœ¨ä¸»è·¯ç”±æ–‡ä»¶ä¸­æ³¨å†Œ APIï¼š

```typescript
// server.ts æˆ– app.ts
import inventoryRouter from './api/inventory';

app.use('/api/inventory', inventoryRouter);
```

3. ç¡®ä¿å·²å®‰è£…ä¾èµ–ï¼š

```bash
npm install express pg
```

4. ç¡®ä¿æ•°æ®åº“è¿æ¥é…ç½®æ­£ç¡®ï¼ˆ`pool` å’Œ `authenticateToken` ä¸­é—´ä»¶ï¼‰

---

### ç¬¬ä¸‰æ­¥ï¼šå‰ç«¯éƒ¨ç½²

1. å°† `src/services/inventoryApiService.ts` å¤åˆ¶åˆ°é¡¹ç›®ä¸­
2. ä¿®æ”¹åçš„ `newDayInventorySync.ts` å·²è‡ªåŠ¨ä½¿ç”¨æ–°çš„ API æœåŠ¡
3. ç¡®ä¿ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®ï¼š

```env
VITE_API_BASE_URL=http://localhost:3000/api
```

4. é‡æ–°æ„å»ºå‰ç«¯ï¼š

```bash
npm run build
```

---

## æ•°æ®è¿ç§»ï¼ˆå¯é€‰ï¼‰

å¦‚æœå¸Œæœ›å°†ç°æœ‰çš„ localStorage æ•°æ®è¿ç§»åˆ°æ•°æ®åº“ï¼š

```typescript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
const localData = localStorage.getItem('allinone_inventory');
if (localData) {
  const items = JSON.parse(localData);
  console.log('æœ¬åœ°åº“å­˜æ•°æ®:', JSON.stringify(items, null, 2));
  // å¤åˆ¶è¿™ä¸ªè¾“å‡ºï¼Œç„¶åè°ƒç”¨ API å¯¼å…¥
}
```

æˆ–è€…åˆ›å»ºä¸€ä¸ªä¸´æ—¶è¿ç§»è„šæœ¬ï¼š

```typescript
// migrate-localstorage-to-db.ts
import { inventoryApiService } from './src/services/inventoryApiService';

async function migrate() {
  const localData = localStorage.getItem('allinone_inventory');
  if (!localData) return;
  
  const items = JSON.parse(localData);
  for (const item of items) {
    await inventoryApiService.addItem({
      itemId: item.id,
      name: item.name,
      description: item.description,
      gameSource: item.gameSource || 'allinone',
      gameName: item.gameName || 'AllinONE',
      category: item.category,
      rarity: item.rarity,
      quantity: item.maxUses || 1,
    });
  }
  console.log('è¿ç§»å®Œæˆ:', items.length, 'ä¸ªé“å…·');
}

migrate();
```

---

## éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥æ•°æ®åº“è¡¨

```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('cross_game_inventory', 'inventory_sync_log');

-- æ£€æŸ¥ç´¢å¼•
SELECT indexname, tablename 
FROM pg_indexes 
WHERE tablename = 'cross_game_inventory';
```

### 2. æµ‹è¯• API

```bash
# è·å–åº“å­˜ï¼ˆéœ€è¦æœ‰æ•ˆ tokenï¼‰
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:3000/api/inventory

# æ·»åŠ é“å…·
curl -X POST \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "itemId": "test-item-001",
    "name": "æµ‹è¯•é“å…·",
    "gameSource": "allinone",
    "quantity": 1
  }' \
  http://localhost:3000/api/inventory
```

### 3. å‰ç«¯æµ‹è¯•

1. ç™»å½• AllinONE
2. è¿›å…¥æ¸¸æˆä¸­å¿ƒï¼Œç‚¹å‡» New Day æ¸¸æˆ
3. åœ¨æ§åˆ¶å°æŸ¥çœ‹åŒæ­¥æ—¥å¿—ï¼š
   ```
   ğŸ”„ å¼€å§‹å…¨é‡åŒæ­¥ New Day åº“å­˜åˆ° AllinONE æ•°æ®åº“...
   âœ… å…¨é‡åŒæ­¥å®Œæˆ: { newDayTotal: X, newlySynced: Y }
   ```
4. åˆ·æ–°é¡µé¢ï¼Œé“å…·åº”è¯¥ä»ç„¶å­˜åœ¨

---

## æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”¨æˆ·æµè§ˆå™¨                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚   AllinONE å‰ç«¯      â”‚                                               â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                               â”‚
â”‚  â”‚  â”‚ åº“å­˜å±•ç¤ºç»„ä»¶   â”‚  â”‚                                               â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                               â”‚
â”‚  â”‚          â”‚          â”‚                                               â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”‚     HTTP API                                  â”‚
â”‚  â”‚  â”‚ inventoryApi  â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚
â”‚  â”‚  â”‚   Service     â”‚  â”‚                                               â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AllinONE åç«¯æœåŠ¡å™¨                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚  Express API        â”‚                                               â”‚
â”‚  â”‚  /api/inventory/*   â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚             â”‚                                                          â”‚
â”‚             â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚   PostgreSQL        â”‚                                               â”‚
â”‚  â”‚  cross_game_        â”‚                                               â”‚
â”‚  â”‚  inventory è¡¨       â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ åŒæ­¥
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              New Day æ¸¸æˆ                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚   æ¸¸æˆå†…é“å…·ç³»ç»Ÿ     â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ•°æ®åº“ç´¢å¼•**ï¼šå·²åˆ›å»ºå¸¸ç”¨æŸ¥è¯¢ç´¢å¼•
2. **åˆ†é¡µæŸ¥è¯¢**ï¼šAPI é»˜è®¤è¿”å› 50 æ¡ï¼Œæ”¯æŒåˆ†é¡µ
3. **æ‰¹é‡åŒæ­¥**ï¼šå…¨é‡åŒæ­¥ä½¿ç”¨äº‹åŠ¡å¤„ç†
4. **ç¼“å­˜ç­–ç•¥**ï¼šå‰ç«¯å¯ç¼“å­˜åº“å­˜æ•°æ®ï¼Œå‡å°‘ API è°ƒç”¨

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šAPI è¿”å› 401
**åŸå› **ï¼šToken æ— æ•ˆæˆ–è¿‡æœŸ
**è§£å†³**ï¼šé‡æ–°ç™»å½•è·å–æ–° token

### é—®é¢˜ 2ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥
**åŸå› **ï¼šæ•°æ®åº“é…ç½®é”™è¯¯
**è§£å†³**ï¼šæ£€æŸ¥ `pool` é…ç½®ä¸­çš„è¿æ¥å­—ç¬¦ä¸²

### é—®é¢˜ 3ï¼šåŒæ­¥æ•°æ®ä¸å®Œæ•´
**åŸå› **ï¼šNew Day API è°ƒç”¨å¤±è´¥
**è§£å†³**ï¼šæ£€æŸ¥ New Day æœåŠ¡çŠ¶æ€å’Œ token æœ‰æ•ˆæ€§

### é—®é¢˜ 4ï¼šé“å…·é‡å¤
**åŸå› **ï¼šå”¯ä¸€ç´¢å¼•å†²çª
**è§£å†³**ï¼šæ£€æŸ¥ `cross_game_inventory` è¡¨çš„å”¯ä¸€çº¦æŸ

---

## å›æ»šæ–¹æ¡ˆ

å¦‚æœéœ€è¦å›æ»šåˆ° localStorage æ–¹æ¡ˆï¼š

1. æ¢å¤ `newDayInventorySync.ts` çš„å¤‡ä»½
2. ç§»é™¤åç«¯ API è·¯ç”±
3. ï¼ˆå¯é€‰ï¼‰å¯¼å‡ºæ•°æ®åº“æ•°æ®åˆ° localStorage

---

## ç›¸å…³æ–‡ä»¶

- `database-schema-inventory.sql` - æ•°æ®åº“è¡¨ç»“æ„
- `src/server/api/inventory.ts` - åç«¯ API ç«¯ç‚¹
- `src/services/inventoryApiService.ts` - å‰ç«¯ API æœåŠ¡
- `src/services/newDayInventorySync.ts` - ä¿®æ”¹åçš„åŒæ­¥æœåŠ¡

---

## å®Œæˆï¼

éƒ¨ç½²å®Œæˆåï¼š
- âœ… åº“å­˜æ•°æ®ä¿å­˜åœ¨ PostgreSQL æ•°æ®åº“
- âœ… è·¨è®¾å¤‡åŒæ­¥å¯ç”¨
- âœ… æ•°æ®ä¸ä¼šä¸¢å¤±ï¼ˆå³ä½¿æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼‰
- âœ… è‡ªåŠ¨å…¨é‡åŒæ­¥ New Day é“å…·
- âœ… æ”¯æŒå†å²åŒæ­¥è®°å½•æŸ¥è¯¢

**è¾›è‹¦ä½ äº†ï¼æœ‰é—®é¢˜éšæ—¶å‘Šè¯‰æˆ‘ï¼** ğŸ’ª
