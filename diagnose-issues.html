<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AllinONE é—®é¢˜è¯Šæ–­</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { color: #667eea; margin-bottom: 20px; text-align: center; }
    h2 { color: #333; margin: 20px 0 10px; font-size: 18px; }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      margin: 5px 0;
      border-radius: 6px;
    }
    .status.ok { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.warning { background: #fff3cd; color: #856404; }
    button {
      padding: 12px 24px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      background: #667eea;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #5568d3; }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .log-entry { margin: 3px 0; }
    .log-info { color: #4fc1ff; }
    .log-success { color: #4ec9b0; }
    .log-error { color: #f48771; }
    .log-warn { color: #dcdcaa; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th { background: #667eea; color: white; }
    code {
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ AllinONE é—®é¢˜è¯Šæ–­å·¥å…·</h1>

    <div class="section">
      <h2>ğŸ“‹ æœ¬åœ°å­˜å‚¨çŠ¶æ€</h2>
      <div id="localStorageStatus"></div>
      <button onclick="checkLocalStorage()">æ£€æŸ¥ LocalStorage</button>
    </div>

    <div class="section">
      <h2>ğŸ”‘ Token çŠ¶æ€</h2>
      <div id="tokenStatus"></div>
      <button onclick="checkTokens()">æ£€æŸ¥ Tokens</button>
    </div>

    <div class="section">
      <h2>ğŸŒ API è¿æ¥æµ‹è¯•</h2>
      <button onclick="testBackendAPI()">æµ‹è¯•åç«¯ API (localhost:3000)</button>
      <button onclick="testNewDayAPI()">æµ‹è¯• New Day API</button>
      <div id="apiResults"></div>
    </div>

    <div class="section">
      <h2>ğŸ—„ï¸ æ•°æ®åº“åŒæ­¥æµ‹è¯•</h2>
      <button onclick="testInventorySync()">æµ‹è¯•åº“å­˜åŒæ­¥</button>
      <div id="syncResults"></div>
    </div>

    <div class="section">
      <h2>ğŸ“ è¯Šæ–­æ—¥å¿—</h2>
      <div class="log" id="logContainer">
        <div class="log-entry log-info">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è¯Šæ–­...</div>
      </div>
      <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>

    <div class="section">
      <h2>ğŸ”§ å¿«é€Ÿä¿®å¤</h2>
      <button onclick="fixMissingTokens()">ä¿®å¤ç¼ºå¤±çš„ Token</button>
      <button onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ® (è°¨æ…ä½¿ç”¨)</button>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000/api';
    const NEWDAY_API = 'https://yxp6y2qgnh.coze.site/api/allinone';

    function log(message, type = 'info') {
      const container = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
    }

    function clearLog() {
      document.getElementById('logContainer').innerHTML = 
        '<div class="log-entry log-info">æ—¥å¿—å·²æ¸…é™¤</div>';
    }

    function checkLocalStorage() {
      log('æ£€æŸ¥ LocalStorage...', 'info');
      const keys = ['user', 'token', 'newday_token', 'allinone_user', 'inventory'];
      let html = '<table><tr><th>Key</th><th>çŠ¶æ€</th><th>å€¼</th></tr>';
      
      keys.forEach(key => {
        const value = localStorage.getItem(key);
        const status = value ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨';
        const displayValue = value 
          ? (value.length > 50 ? value.substring(0, 50) + '...' : value)
          : '-';
        html += `<tr><td><code>${key}</code></td><td>${status}</td><td>${displayValue}</td></tr>`;
      });
      
      html += '</table>';
      document.getElementById('localStorageStatus').innerHTML = html;
      log('LocalStorage æ£€æŸ¥å®Œæˆ', 'success');
    }

    function checkTokens() {
      log('æ£€æŸ¥ Tokens...', 'info');
      
      const allinoneToken = localStorage.getItem('token');
      const newdayToken = localStorage.getItem('newday_token');
      const userStr = localStorage.getItem('user');
      
      let html = '';
      
      if (!allinoneToken && !newdayToken) {
        html += '<div class="status error">âŒ æ²¡æœ‰ä»»ä½• Tokenï¼Œè¯·å…ˆç™»å½•</div>';
        log('æ²¡æœ‰æ‰¾åˆ°ä»»ä½• Token', 'error');
      } else {
        if (allinoneToken) {
          html += `<div class="status ok">âœ… AllinONE Token: ${allinoneToken.substring(0, 30)}...</div>`;
          log('æ‰¾åˆ° AllinONE Token', 'success');
        } else {
          html += '<div class="status warning">âš ï¸ ç¼ºå°‘ AllinONE Token</div>';
          log('ç¼ºå°‘ AllinONE Token', 'warn');
        }
        
        if (newdayToken) {
          html += `<div class="status ok">âœ… New Day Token: ${newdayToken.substring(0, 30)}...</div>`;
          log('æ‰¾åˆ° New Day Token', 'success');
        } else {
          html += '<div class="status warning">âš ï¸ ç¼ºå°‘ New Day Token</div>';
          log('ç¼ºå°‘ New Day Token', 'warn');
        }
      }
      
      if (userStr) {
        try {
          const user = JSON.parse(userStr);
          html += `<div class="status ok">âœ… ç”¨æˆ·ä¿¡æ¯: ${user.username || user.userId || 'æœªçŸ¥'}</div>`;
          log(`æ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(user)}`, 'success');
        } catch (e) {
          html += '<div class="status error">âŒ ç”¨æˆ·ä¿¡æ¯æ ¼å¼é”™è¯¯</div>';
          log('ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥', 'error');
        }
      } else {
        html += '<div class="status error">âŒ ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯</div>';
        log('ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯', 'error');
      }
      
      document.getElementById('tokenStatus').innerHTML = html;
    }

    async function testBackendAPI() {
      log('æµ‹è¯•åç«¯ API...', 'info');
      
      try {
        const response = await fetch(`${API_BASE}/health`);
        const data = await response.json();
        
        let html = '<div class="status ok">âœ… åç«¯æœåŠ¡å™¨è¿è¡Œæ­£å¸¸</div>';
        html += `<div>çŠ¶æ€: ${data.status}</div>`;
        html += `<div>æ—¶é—´: ${data.timestamp}</div>`;
        html += `<div>æ•°æ®åº“: ${data.database}</div>`;
        
        document.getElementById('apiResults').innerHTML = html;
        log('åç«¯ API æµ‹è¯•æˆåŠŸ', 'success');
      } catch (error) {
        document.getElementById('apiResults').innerHTML = 
          `<div class="status error">âŒ åç«¯æœåŠ¡å™¨æœªå¯åŠ¨: ${error.message}</div>`;
        log(`åç«¯ API æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testNewDayAPI() {
      log('æµ‹è¯• New Day API...', 'info');
      
      const token = localStorage.getItem('newday_token');
      if (!token) {
        document.getElementById('apiResults').innerHTML += 
          '<div class="status error">âŒ ç¼ºå°‘ New Day Tokenï¼Œæ— æ³•æµ‹è¯•</div>';
        log('ç¼ºå°‘ New Day Token', 'error');
        return;
      }
      
      try {
        const response = await fetch(`${NEWDAY_API}/inventory`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          document.getElementById('apiResults').innerHTML += 
            `<div class="status ok">âœ… New Day API è¿æ¥æˆåŠŸ (${data.items?.length || 0} ä¸ªé“å…·)</div>`;
          log('New Day API æµ‹è¯•æˆåŠŸ', 'success');
        } else {
          document.getElementById('apiResults').innerHTML += 
            `<div class="status error">âŒ New Day API è¿”å› ${response.status}</div>`;
          log(`New Day API è¿”å›é”™è¯¯: ${response.status}`, 'error');
        }
      } catch (error) {
        document.getElementById('apiResults').innerHTML += 
          `<div class="status error">âŒ New Day API è¿æ¥å¤±è´¥: ${error.message}</div>`;
        log(`New Day API æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testInventorySync() {
      log('æµ‹è¯•åº“å­˜åŒæ­¥...', 'info');
      
      const token = localStorage.getItem('token') || localStorage.getItem('newday_token');
      if (!token) {
        document.getElementById('syncResults').innerHTML = 
          '<div class="status error">âŒ ç¼ºå°‘ Tokenï¼Œæ— æ³•æµ‹è¯•åŒæ­¥</div>';
        log('ç¼ºå°‘ Tokenï¼Œæ— æ³•æµ‹è¯•', 'error');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/inventory`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.status === 401) {
          document.getElementById('syncResults').innerHTML = 
            '<div class="status error">âŒ 401 æœªæˆæƒ - Token æ— æ•ˆæˆ–è¿‡æœŸ</div>';
          log('åº“å­˜ API è¿”å› 401 æœªæˆæƒ', 'error');
        } else if (response.ok) {
          const data = await response.json();
          document.getElementById('syncResults').innerHTML = 
            `<div class="status ok">âœ… åº“å­˜ API è¿æ¥æˆåŠŸ (${data.data?.pagination?.total || 0} ä¸ªé“å…·)</div>`;
          log('åº“å­˜ API æµ‹è¯•æˆåŠŸ', 'success');
        } else {
          document.getElementById('syncResults').innerHTML = 
            `<div class="status error">âŒ åº“å­˜ API è¿”å› ${response.status}</div>`;
          log(`åº“å­˜ API è¿”å›é”™è¯¯: ${response.status}`, 'error');
        }
      } catch (error) {
        document.getElementById('syncResults').innerHTML = 
          `<div class="status error">âŒ åº“å­˜ API è¿æ¥å¤±è´¥: ${error.message}</div>`;
        log(`åº“å­˜ API æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }

    function fixMissingTokens() {
      log('å°è¯•ä¿®å¤ç¼ºå¤±çš„ Token...', 'info');
      
      const newdayToken = localStorage.getItem('newday_token');
      const userStr = localStorage.getItem('user');
      
      if (!userStr) {
        // åˆ›å»ºé»˜è®¤ç”¨æˆ·
        const defaultUser = { userId: '1', username: 'default_user' };
        localStorage.setItem('user', JSON.stringify(defaultUser));
        log('åˆ›å»ºé»˜è®¤ç”¨æˆ·', 'warn');
      }
      
      if (!localStorage.getItem('token') && newdayToken) {
        // ä½¿ç”¨ New Day token ä½œä¸º AllinONE token
        localStorage.setItem('token', newdayToken);
        log('ä½¿ç”¨ New Day Token ä½œä¸º AllinONE Token', 'warn');
      }
      
      log('Token ä¿®å¤å®Œæˆï¼Œè¯·é‡æ–°æ£€æŸ¥', 'success');
      checkTokens();
    }

    function clearAllData() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ localStorage æ•°æ®å—ï¼Ÿè¿™å°†éœ€è¦é‡æ–°ç™»å½•ã€‚')) {
        localStorage.clear();
        log('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'warn');
        checkLocalStorage();
      }
    }

    // è‡ªåŠ¨è¿è¡Œä¸€æ¬¡æ£€æŸ¥
    window.onload = () => {
      checkLocalStorage();
      checkTokens();
    };
  </script>
</body>
</html>
