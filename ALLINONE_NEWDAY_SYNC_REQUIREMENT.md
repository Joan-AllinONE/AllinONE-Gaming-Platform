# AllinONE é“å…·åŒæ­¥åˆ° New Day éœ€æ±‚æ–‡æ¡£

## ä¸€ã€éœ€æ±‚æ¦‚è¿°

å®ç° AllinONE å¹³å°é“å…·åˆ° New Day æ¸¸æˆçš„åŒæ­¥åŠŸèƒ½ï¼Œé‡‡ç”¨**éå®æ—¶ã€ç”¨æˆ·ä¸»åŠ¨è§¦å‘**çš„åŒæ­¥æ¨¡å¼ã€‚

## äºŒã€æ ¸å¿ƒåŸåˆ™

1. **éå®æ—¶åŒæ­¥**ï¼šé“å…·é»˜è®¤å­˜å‚¨åœ¨ AllinONEï¼Œä¸è‡ªåŠ¨åŒæ­¥åˆ° New Day
2. **ç”¨æˆ·ä¸»åŠ¨è§¦å‘**ï¼šç©å®¶é€šè¿‡ç‚¹å‡»"åŒæ­¥åˆ° New Day"æŒ‰é’®ä¸»åŠ¨å‘èµ·åŒæ­¥
3. **æ•°æ®ä¸€è‡´æ€§**ï¼šåŒæ­¥æˆåŠŸåï¼ŒAllinONE å’Œ New Day éƒ½æ‹¥æœ‰è¯¥é“å…·
4. **é”™è¯¯å¤„ç†**ï¼šåŒæ­¥å¤±è´¥æ—¶ä¿ç•™ AllinONE æ•°æ®ï¼Œä¸å½±å“ç©å®¶ä½¿ç”¨

## ä¸‰ã€éœ€æ±‚åœºæ™¯

### åœºæ™¯ 1ï¼šAllinONE å®˜æ–¹å•†åº—è´­ä¹° New Day é“å…·

1. ç©å®¶åœ¨ AllinONE å®˜æ–¹å•†åº—è´­ä¹° New Day é“å…·ï¼ˆå¦‚"é»æ˜ä¹‹å‰‘"ï¼‰
2. é“å…·ç«‹å³æ·»åŠ åˆ° AllinONE æ•°æ®åº“åº“å­˜
3. é“å…·åœ¨è·¨æ¸¸æˆåº“å­˜ä¸­æ˜¾ç¤ºï¼Œæ ‡æ³¨ `æ¥æº: AllinONE å®˜æ–¹å•†åº—`
4. é“å…·å¡ç‰‡æ˜¾ç¤º"åŒæ­¥åˆ° New Day"æŒ‰é’®ï¼ˆå¯ç‚¹å‡»ï¼‰

### åœºæ™¯ 2ï¼šç©å®¶ä¸»åŠ¨åŒæ­¥é“å…·åˆ° New Day

1. ç©å®¶åœ¨è·¨æ¸¸æˆåº“å­˜ä¸­æ‰¾åˆ°è´­ä¹°çš„ New Day é“å…·
2. ç‚¹å‡»"åŒæ­¥åˆ° New Day"æŒ‰é’®
3. å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†ï¼š
   ```
   âš ï¸ ç¡®è®¤å°†æ­¤é“å…·åŒæ­¥åˆ° New Day æ¸¸æˆï¼Ÿ
   
   é“å…·: [New Day] é»æ˜ä¹‹å‰‘
   ç¨€æœ‰åº¦: å²è¯—
   
   åŒæ­¥åï¼š
   â€¢ New Day æ¸¸æˆä¸­å°†æ˜¾ç¤ºæ­¤é“å…·
   â€¢ é“å…·å¯åœ¨ New Day ä¸­ä½¿ç”¨
   â€¢ æ­¤æ“ä½œä¸å¯æ’¤é”€
   
   [å–æ¶ˆ] [ç¡®è®¤åŒæ­¥]
   ```
4. ç©å®¶ç¡®è®¤åï¼Œè°ƒç”¨ New Day API åŒæ­¥é“å…·
5. åŒæ­¥æˆåŠŸï¼š
   - é“å…·åœ¨ New Day ä¸­å¯ç”¨
   - AllinONE ä¸­è¯¥é“å…·æ ‡æ³¨"å·²åŒæ­¥åˆ° New Day"
   - åŒæ­¥æŒ‰é’®å˜ä¸ºç°è‰²ï¼ˆç¦ç”¨çŠ¶æ€ï¼‰ï¼Œæ˜¾ç¤º"å·²åŒæ­¥"
6. åŒæ­¥å¤±è´¥ï¼š
   - æ˜¾ç¤ºé”™è¯¯æç¤ºï¼š"åŒæ­¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"
   - é“å…·ä¿ç•™åœ¨ AllinONE ä¸­
   - åŒæ­¥æŒ‰é’®ä»å¯ç‚¹å‡»

### åœºæ™¯ 3ï¼šåŒæ­¥çŠ¶æ€ç®¡ç†

**æœªåŒæ­¥çŠ¶æ€ï¼š**
- é“å…·å¡ç‰‡æ˜¾ç¤ºè“è‰²æŒ‰é’®"ğŸ“¤ åŒæ­¥åˆ° New Day"
- é¼ æ ‡æ‚¬åœæç¤ºï¼š"å°†æ­¤é“å…·åŒæ­¥åˆ° New Day æ¸¸æˆ"

**å·²åŒæ­¥çŠ¶æ€ï¼š**
- é“å…·å¡ç‰‡æ˜¾ç¤ºç°è‰²æ ‡ç­¾"âœ… å·²åŒæ­¥åˆ° New Day"
- æ— åŒæ­¥æŒ‰é’®
- é¼ æ ‡æ‚¬åœæç¤ºï¼š"æ­¤é“å…·å·²åŒæ­¥åˆ° New Day"

**åŒæ­¥ä¸­çŠ¶æ€ï¼š**
- æŒ‰é’®å˜ä¸ºåŠ è½½çŠ¶æ€ï¼š"ğŸ”„ åŒæ­¥ä¸­..."
- é“å…·å¡ç‰‡åŠé€æ˜
- ç¦æ­¢å…¶ä»–æ“ä½œ

## å››ã€æŠ€æœ¯éœ€æ±‚

### 4.1 New Day API æ–°å¢ç«¯ç‚¹

#### ç«¯ç‚¹ 1ï¼šæ·»åŠ é“å…·åˆ° New Day åº“å­˜

```typescript
POST /api/allinone/inventory/add

è¯·æ±‚å¤´:
  Authorization: Bearer {newDayToken}
  Content-Type: application/json

è¯·æ±‚ä½“:
{
  "itemId": "nd_owned_1234567890_abc123",
  "name": "[New Day] é»æ˜ä¹‹å‰‘",
  "description": "ä¼ è¯´ä¸­çš„é»æ˜ä¹‹å‰‘ï¼Œæ”»å‡»åŠ›+50",
  "type": "weapon",
  "rarity": "epic",
  "quantity": 1,
  "stats": {
    "attack": 50
  },
  "originalSource": "allinone_official_store"
}

æˆåŠŸå“åº” (200):
{
  "success": true,
  "message": "é“å…·æ·»åŠ æˆåŠŸ",
  "item": {
    "id": "newday_original_id_123",
    "name": "[New Day] é»æ˜ä¹‹å‰‘",
    ...
  }
}

å¤±è´¥å“åº”:
{
  "success": false,
  "message": "æ·»åŠ å¤±è´¥ï¼šé“å…·å·²å­˜åœ¨",
  "errorCode": "ITEM_ALREADY_EXISTS"
}
```

#### ç«¯ç‚¹ 2ï¼šæŸ¥è¯¢é“å…·åŒæ­¥çŠ¶æ€ï¼ˆå¯é€‰ï¼‰

```typescript
GET /api/allinone/inventory/sync-status?itemId={itemId}

æˆåŠŸå“åº”:
{
  "success": true,
  "synced": true,
  "syncedAt": "2026-02-09T10:30:00Z"
}
```

### 4.2 AllinONE å‰ç«¯ä¿®æ”¹

#### 4.2.1 æ•°æ®åº“å­—æ®µæ‰©å±•

åœ¨ AllinONE åº“å­˜è¡¨ä¸­æ·»åŠ å­—æ®µï¼š

```sql
ALTER TABLE inventory ADD COLUMN sync_status VARCHAR(20) DEFAULT 'not_synced';
ALTER TABLE inventory ADD COLUMN synced_at TIMESTAMP NULL;
```

**å­—æ®µè¯´æ˜ï¼š**
- `sync_status`: åŒæ­¥çŠ¶æ€ï¼Œå¯é€‰å€¼ï¼š
  - `not_synced` - æœªåŒæ­¥
  - `syncing` - åŒæ­¥ä¸­
  - `synced` - å·²åŒæ­¥
  - `failed` - åŒæ­¥å¤±è´¥
- `synced_at`: åŒæ­¥å®Œæˆæ—¶é—´

#### 4.2.2 åç«¯ API æ–°å¢

```typescript
// src/services/inventoryApiService.ts

/**
 * æ›´æ–°é“å…·åŒæ­¥çŠ¶æ€
 */
async updateSyncStatus(itemId: string, status: string, syncedAt?: Date): Promise<void> {
  const response = await this.request<any>(`/inventory/${itemId}/sync-status`, {
    method: 'PATCH',
    body: JSON.stringify({
      syncStatus: status,
      syncedAt: syncedAt?.toISOString(),
    }),
  });
  return response.data;
}
```

#### 4.2.3 å‰ç«¯ UI ç»„ä»¶ä¿®æ”¹

**ç»„ä»¶ï¼š** `CrossGameInventory.tsx`

```typescript
interface InventoryItemWithSync extends CrossGameInventoryItem {
  syncStatus?: 'not_synced' | 'syncing' | 'synced' | 'failed';
  syncedAt?: Date;
}

// åŒæ­¥åˆ° New Day æ–¹æ³•
const syncToNewDay = async (item: InventoryItemWithSync) => {
  if (item.syncStatus === 'synced') {
    alert('æ­¤é“å…·å·²åŒæ­¥åˆ° New Day');
    return;
  }

  const confirmed = confirm(
    `âš ï¸ ç¡®è®¤å°†æ­¤é“å…·åŒæ­¥åˆ° New Day æ¸¸æˆï¼Ÿ\n\n` +
    `é“å…·: ${item.name}\n` +
    `ç¨€æœ‰åº¦: ${item.rarity}\n\n` +
    `åŒæ­¥åï¼š\n` +
    `â€¢ New Day æ¸¸æˆä¸­å°†æ˜¾ç¤ºæ­¤é“å…·\n` +
    `â€¢ é“å…·å¯åœ¨ New Day ä¸­ä½¿ç”¨\n` +
    `â€¢ æ­¤æ“ä½œä¸å¯æ’¤é”€`
  );

  if (!confirmed) return;

  try {
    // 1. æ›´æ–°çŠ¶æ€ä¸ºåŒæ­¥ä¸­
    await inventoryApiService.updateSyncStatus(item.id, 'syncing');
    setItems(items.map(i => 
      i.id === item.id ? { ...i, syncStatus: 'syncing' } : i
    ));

    // 2. è°ƒç”¨ New Day API åŒæ­¥é“å…·
    const result = await newDayApiService.addItemToNewDay({
      itemId: item.id,
      name: item.name,
      description: item.description,
      type: item.category,
      rarity: item.rarity,
      quantity: 1,
      stats: item.stats,
      originalSource: 'allinone_official_store'
    });

    if (result.success) {
      // 3. æ›´æ–°çŠ¶æ€ä¸ºå·²åŒæ­¥
      await inventoryApiService.updateSyncStatus(
        item.id,
        'synced',
        new Date()
      );
      setItems(items.map(i => 
        i.id === item.id 
          ? { ...i, syncStatus: 'synced', syncedAt: new Date() } 
          : i
      ));
      alert('âœ… åŒæ­¥æˆåŠŸï¼é“å…·å·²æ·»åŠ åˆ° New Day æ¸¸æˆ');
    } else {
      throw new Error(result.message || 'åŒæ­¥å¤±è´¥');
    }
  } catch (error: any) {
    console.error('âŒ åŒæ­¥åˆ° New Day å¤±è´¥:', error);
    
    // 4. æ›´æ–°çŠ¶æ€ä¸ºå¤±è´¥
    await inventoryApiService.updateSyncStatus(item.id, 'failed');
    setItems(items.map(i => 
      i.id === item.id ? { ...i, syncStatus: 'failed' } : i
    ));
    
    alert(`âŒ åŒæ­¥å¤±è´¥: ${error.message}`);
  }
};
```

**UI æ˜¾ç¤ºé€»è¾‘ï¼š**

```tsx
<div className="inventory-item-card">
  <div className="item-header">
    <h3>{item.name}</h3>
    {item.gameSource === 'newday' && item.syncStatus && (
      <SyncBadge status={item.syncStatus} />
    )}
  </div>
  
  {/* åŒæ­¥æŒ‰é’® */}
  {item.gameSource === 'newday' && 
   item.syncStatus === 'not_synced' && (
    <button 
      onClick={() => syncToNewDay(item)}
      className="btn-sync"
    >
      ğŸ“¤ åŒæ­¥åˆ° New Day
    </button>
  )}
  
  {item.gameSource === 'newday' && 
   item.syncStatus === 'syncing' && (
    <button disabled className="btn-sync disabled">
      ğŸ”„ åŒæ­¥ä¸­...
    </button>
  )}
  
  {item.gameSource === 'newday' && 
   item.syncStatus === 'failed' && (
    <button 
      onClick={() => syncToNewDay(item)}
      className="btn-sync retry"
    >
      ğŸ”„ é‡è¯•åŒæ­¥
    </button>
  )}
</div>

// åŒæ­¥çŠ¶æ€å¾½ç« ç»„ä»¶
function SyncBadge({ status }: { status: string }) {
  switch (status) {
    case 'synced':
      return (
        <span className="badge synced" title="å·²åŒæ­¥åˆ° New Day">
          âœ… å·²åŒæ­¥åˆ° New Day
        </span>
      );
    case 'failed':
      return (
        <span className="badge failed" title="åŒæ­¥å¤±è´¥">
          âŒ åŒæ­¥å¤±è´¥
        </span>
      );
    default:
      return null;
  }
}
```

### 4.3 `newDayApiService.ts` æ–°å¢æ–¹æ³•

```typescript
/**
 * æ·»åŠ é“å…·åˆ° New Day åº“å­˜
 * @param item é“å…·ä¿¡æ¯
 * @returns åŒæ­¥ç»“æœ
 */
async addItemToNewDay(item: {
  itemId: string;
  name: string;
  description: string;
  type: string;
  rarity: string;
  quantity: number;
  stats?: any;
  originalSource?: string;
}): Promise<{ success: boolean; message?: string; data?: any }> {
  try {
    console.log('ğŸ“¤ æ·»åŠ é“å…·åˆ° New Day:', item);
    
    const headers = await this.getAuthHeaders();
    const response = await fetch(`${this.API_BASE}/inventory/add`, {
      method: 'POST',
      headers,
      body: JSON.stringify(item),
    });

    console.log('ğŸ“¥ New Day API å“åº”çŠ¶æ€:', response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('âŒ New Day API è¿”å›é”™è¯¯:', response.status, errorText);
      return {
        success: false,
        message: `æ·»åŠ å¤±è´¥: ${response.status} ${errorText}`
      };
    }

    const data = await response.json();
    console.log('âœ… New Day æ·»åŠ é“å…·æˆåŠŸ:', data);
    
    return {
      success: data.success || false,
      message: data.message,
      data: data.item
    };
  } catch (error: any) {
    console.error('âŒ æ·»åŠ é“å…·åˆ° New Day å¼‚å¸¸:', error);
    return {
      success: false,
      message: error?.message || 'ç½‘ç»œé”™è¯¯'
    };
  }
}

/**
 * æŸ¥è¯¢é“å…·åŒæ­¥çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
 */
async getSyncStatus(itemId: string): Promise<{ success: boolean; synced?: boolean; syncedAt?: string }> {
  try {
    const headers = await this.getAuthHeaders();
    const response = await fetch(
      `${this.API_BASE}/inventory/sync-status?itemId=${itemId}`,
      { headers }
    );

    if (!response.ok) {
      return { success: false };
    }

    const data = await response.json();
    return {
      success: true,
      synced: data.synced,
      syncedAt: data.syncedAt
    };
  } catch (error) {
    console.error('âŒ æŸ¥è¯¢åŒæ­¥çŠ¶æ€å¤±è´¥:', error);
    return { success: false };
  }
}
```

### 4.4 æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

```sql
-- ä¸ºç°æœ‰é“å…·æ·»åŠ é»˜è®¤åŒæ­¥çŠ¶æ€
UPDATE inventory 
SET sync_status = 'not_synced' 
WHERE game_source = 'newday' 
  AND sync_status IS NULL;

-- æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX idx_inventory_sync_status ON inventory(sync_status);
CREATE INDEX idx_inventory_game_source ON inventory(game_source);
```

## äº”ã€å®æ–½æ­¥éª¤

### é˜¶æ®µä¸€ï¼šNew Day åç«¯å¼€å‘

- [ ] å®ç° `POST /api/allinone/inventory/add` ç«¯ç‚¹
- [ ] å®ç° `GET /api/allinone/inventory/sync-status` ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰
- [ ] æ·»åŠ é“å…·å»é‡é€»è¾‘ï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
- [ ] å•å…ƒæµ‹è¯•

### é˜¶æ®µäºŒï¼šAllinONE åç«¯å¼€å‘

- [ ] æ•°æ®åº“æ·»åŠ  `sync_status` å’Œ `synced_at` å­—æ®µ
- [ ] å®ç° `PATCH /api/inventory/{itemId}/sync-status` ç«¯ç‚¹
- [ ] `inventoryApiService` æ·»åŠ  `updateSyncStatus` æ–¹æ³•
- [ ] API æµ‹è¯•

### é˜¶æ®µä¸‰ï¼šAllinONE å‰ç«¯å¼€å‘

- [ ] `CrossGameInventory.tsx` æ·»åŠ åŒæ­¥çŠ¶æ€æ˜¾ç¤º
- [ ] å®ç°åŒæ­¥æŒ‰é’® UIï¼ˆæœªåŒæ­¥/åŒæ­¥ä¸­/å·²åŒæ­¥/å¤±è´¥ï¼‰
- [ ] å®ç°ç¡®è®¤å¯¹è¯æ¡†
- [ ] `newDayApiService` æ·»åŠ  `addItemToNewDay` æ–¹æ³•
- [ ] é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
- [ ] UI æ ·å¼ä¼˜åŒ–

### é˜¶æ®µå››ï¼šæµ‹è¯•ä¸ä¼˜åŒ–

- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆè´­ä¹° â†’ åŒæ­¥ â†’ éªŒè¯ï¼‰
- [ ] è¾¹ç•Œæµ‹è¯•ï¼ˆç½‘ç»œå¼‚å¸¸ã€é‡å¤åŒæ­¥ç­‰ï¼‰
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ–‡æ¡£å®Œå–„

## å…­ã€æ³¨æ„äº‹é¡¹

### 6.1 æ•°æ®ä¸€è‡´æ€§

- åŒæ­¥æˆåŠŸåï¼ŒAllinONE å’Œ New Day åº”å„è‡ªç»´æŠ¤é“å…·å‰¯æœ¬
- åç»­ä¿®æ”¹ï¼ˆå¦‚å‡çº§ã€äº¤æ˜“ï¼‰ä¸å½±å“å¦ä¸€ç«¯çš„é“å…·
- å»ºè®®åœ¨é“å…·æè¿°ä¸­æ ‡æ³¨"ä» AllinONE åŒæ­¥"

### 6.2 é”™è¯¯å¤„ç†

- ç½‘ç»œè¶…æ—¶ï¼šæç¤ºç©å®¶æ£€æŸ¥ç½‘ç»œï¼Œä¿ç•™é‡è¯•é€‰é¡¹
- é‡å¤æ·»åŠ ï¼šNew Day åç«¯è¿”å› `ITEM_ALREADY_EXISTS` é”™è¯¯ç 
- è®¤è¯å¤±è´¥ï¼šæç¤ºç©å®¶é‡æ–°ç™»å½• New Day

### 6.3 æ€§èƒ½è€ƒè™‘

- æ‰¹é‡åŒæ­¥ï¼šå¦‚æœç©å®¶æœ‰å¤šé“å…·å¾…åŒæ­¥ï¼Œæ”¯æŒæ‰¹é‡æ“ä½œï¼ˆåæœŸä¼˜åŒ–ï¼‰
- çŠ¶æ€ç¼“å­˜ï¼šåŒæ­¥çŠ¶æ€ç¼“å­˜ 5 åˆ†é’Ÿï¼Œå‡å°‘é‡å¤æŸ¥è¯¢
- æŒ‰é’®é˜²æŠ–ï¼šé¿å…é‡å¤ç‚¹å‡»

### 6.4 å®‰å…¨è€ƒè™‘

- éªŒè¯ç”¨æˆ·æ‰€æœ‰æƒï¼šåªæœ‰é“å…·æ‰€æœ‰è€…æ‰èƒ½åŒæ­¥
- é˜²æ­¢ä¼ªé€ ï¼šéªŒè¯è¯·æ±‚æ¥æºä¸º AllinONE å®˜æ–¹
- è®°å½•å®¡è®¡æ—¥å¿—ï¼šè®°å½•æ‰€æœ‰åŒæ­¥æ“ä½œ

## ä¸ƒã€éªŒæ”¶æ ‡å‡†

- [ ] ç©å®¶è´­ä¹° New Day é“å…·åï¼Œé“å…·åªåœ¨ AllinONE æ˜¾ç¤º
- [ ] æœªåŒæ­¥é“å…·æ˜¾ç¤º"ğŸ“¤ åŒæ­¥åˆ° New Day"æŒ‰é’®
- [ ] ç‚¹å‡»åŒæ­¥æŒ‰é’®å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
- [ ] ç¡®è®¤åæˆåŠŸåŒæ­¥åˆ° New Day æ¸¸æˆ
- [ ] åŒæ­¥æˆåŠŸåæŒ‰é’®å˜ä¸º"âœ… å·²åŒæ­¥åˆ° New Day"æ ‡ç­¾
- [ ] åŒæ­¥å¤±è´¥æ—¶é“å…·ä¿ç•™åœ¨ AllinONEï¼Œæ”¯æŒé‡è¯•
- [ ] å·²åŒæ­¥é“å…·æ— æ³•é‡å¤åŒæ­¥

## å…«ã€é™„å½•

### 8.1 ç›¸å…³æ–‡ä»¶

- New Day API: `https://yxp6y2qgnh.coze.site/api/allinone`
- AllinONE å‰ç«¯ç»„ä»¶: `src/components/CrossGameInventory.tsx`
- AllinONE API æœåŠ¡: `src/services/newDayApiService.ts`
- AllinONE åº“å­˜æœåŠ¡: `src/services/inventoryApiService.ts`

### 8.2 è”ç³»æ–¹å¼

å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»ï¼š
- AllinONE å¼€å‘å›¢é˜Ÿ
- New Day å¼€å‘å›¢é˜Ÿ

---

**æ–‡æ¡£ç‰ˆæœ¬:** 1.0  
**åˆ›å»ºæ—¥æœŸ:** 2026-02-09  
**æœ€åæ›´æ–°:** 2026-02-09
