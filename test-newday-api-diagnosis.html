<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Day API è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        .container {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: #0f3460;
            border-radius: 6px;
            border-left: 4px solid #555;
        }
        .test-item.pending { border-left-color: #555; }
        .test-item.loading { border-left-color: #f39c12; }
        .test-item.success { border-left-color: #27ae60; }
        .test-item.error { border-left-color: #e74c3c; }
        .status {
            font-weight: bold;
            margin-right: 15px;
            min-width: 80px;
        }
        .status.pending { color: #95a5a6; }
        .status.loading { color: #f39c12; }
        .status.success { color: #27ae60; }
        .status.error { color: #e74c3c; }
        .message {
            flex: 1;
        }
        .data-display {
            background: #0f3460;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #ff6b6b;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        h2 {
            color: #e94560;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” New Day API è¯Šæ–­å·¥å…·</h1>

    <div class="container">
        <button id="runTests" onclick="runAllTests()">â–¶ï¸ å¼€å§‹è¯Šæ–­</button>
        <div id="progress" style="margin-top: 10px; color: #95a5a6;"></div>
    </div>

    <div class="container">
        <h2>ğŸ“Š è¯Šæ–­ç»“æœ</h2>
        <div id="testResults"></div>
    </div>

    <script>
        const API_BASE = 'https://yxp6y2qgnh.coze.site';
        const SHARED_API = `${API_BASE}/api/shared`;
        const ALLINONE_API = `${API_BASE}/api/allinone`;

        const testResults = [
            { name: '1. å…±äº«å¸‚åœº API (æ— éœ€è®¤è¯)', status: 'pending', message: '', data: null },
            { name: '2. å…±äº«é’±åŒ… API (æ— éœ€è®¤è¯)', status: 'pending', message: '', data: null },
            { name: '3. AllinONE ç™»å½• API', status: 'pending', message: '', data: null },
            { name: '4. AllinONE é’±åŒ… API (éœ€è¦è®¤è¯)', status: 'pending', message: '', data: null },
            { name: '5. AllinONE åº“å­˜ API (éœ€è¦è®¤è¯)', status: 'pending', message: '', data: null },
            { name: '6. AllinONE å¸‚åœº API (éœ€è¦è®¤è¯)', status: 'pending', message: '', data: null },
        ];

        async function runAllTests() {
            const button = document.getElementById('runTests');
            const progress = document.getElementById('progress');
            button.disabled = true;
            progress.textContent = 'æ­£åœ¨è¯Šæ–­...';

            let token = null;

            try {
                // æµ‹è¯• 1: å…±äº«å¸‚åœº
                await testSharedMarket();

                // æµ‹è¯• 2: å…±äº«é’±åŒ…
                await testSharedWallet();

                // æµ‹è¯• 3: ç™»å½•ï¼ˆä¸é˜»å¡åç»­æµ‹è¯•ï¼‰
                const loginResult = await testLogin();
                token = loginResult.token;

                // æµ‹è¯• 4-6: è®¤è¯ç›¸å…³çš„ APIï¼ˆå³ä½¿ç™»å½•å¤±è´¥ä¹Ÿå°è¯•ï¼‰
                if (token) {
                    await testAllinOneWallet(token);
                    await testAllinOneInventory(token);
                    await testAllinOneMarket(token);
                } else {
                    updateTestStatus(3, 'error', 'è·³è¿‡ï¼ˆéœ€è¦è®¤è¯ï¼‰');
                    updateTestStatus(4, 'error', 'è·³è¿‡ï¼ˆéœ€è¦è®¤è¯ï¼‰');
                    updateTestStatus(5, 'error', 'è·³è¿‡ï¼ˆéœ€è¦è®¤è¯ï¼‰');
                }

                progress.textContent = 'âœ… è¯Šæ–­å®Œæˆ';
            } catch (error) {
                progress.textContent = 'âŒ è¯Šæ–­è¿‡ç¨‹å‡ºé”™: ' + error.message;
            } finally {
                button.disabled = false;
            }
        }

        async function testSharedMarket() {
            updateTestStatus(0, 'loading', 'æ­£åœ¨æµ‹è¯•å…±äº«å¸‚åœº...');
            try {
                const response = await fetch(`${SHARED_API}/marketplace`);
                if (response.ok) {
                    const data = await response.json();
                    updateTestStatus(0, 'success', `æˆåŠŸï¼Œè¿”å› ${data.items?.length || 0} ä¸ªç‰©å“`, data);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateTestStatus(0, 'error', error.message);
            }
        }

        async function testSharedWallet() {
            updateTestStatus(1, 'loading', 'æ­£åœ¨æµ‹è¯•å…±äº«é’±åŒ…...');
            try {
                const response = await fetch(`${SHARED_API}/wallet/diagnostic-test-${Date.now()}`);
                if (response.ok) {
                    const data = await response.json();
                    updateTestStatus(1, 'success', 'æˆåŠŸåˆ›å»ºé’±åŒ…', data);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`HTTP ${response.status}: ${errorData.message || errorData.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                updateTestStatus(1, 'error', error.message);
            }
        }

        async function testLogin() {
            updateTestStatus(2, 'loading', 'æ­£åœ¨æµ‹è¯•ç™»å½•...');
            try {
                const response = await fetch(`${ALLINONE_API}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        allinoneUserId: 'test-user-123',
                        allinoneUsername: 'testuser'
                    })
                });

                const data = await response.json();

                if (response.ok && data.success && data.data && data.data.token) {
                    updateTestStatus(2, 'success', 'ç™»å½•æˆåŠŸ', {
                        token: data.data.token.substring(0, 20) + '...',
                        userId: data.data.userId
                    });
                    return { token: data.data.token };
                } else {
                    updateTestStatus(2, 'error', data.message || 'ç™»å½•å¤±è´¥');
                    return { token: null };
                }
            } catch (error) {
                updateTestStatus(2, 'error', error.message);
                return { token: null };
            }
        }

        async function testAllinOneWallet(token) {
            updateTestStatus(3, 'loading', 'æ­£åœ¨æµ‹è¯• AllinONE é’±åŒ…...');
            try {
                const response = await fetch(`${ALLINONE_API}/wallet/balance`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    updateTestStatus(3, 'success', 'æˆåŠŸè·å–é’±åŒ…', data);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateTestStatus(3, 'error', error.message);
            }
        }

        async function testAllinOneInventory(token) {
            updateTestStatus(4, 'loading', 'æ­£åœ¨æµ‹è¯• AllinONE åº“å­˜...');
            try {
                const response = await fetch(`${ALLINONE_API}/inventory`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    updateTestStatus(4, 'success', `æˆåŠŸè·å– ${data.items?.length || 0} ä¸ªç‰©å“`, data);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateTestStatus(4, 'error', error.message);
            }
        }

        async function testAllinOneMarket(token) {
            updateTestStatus(5, 'loading', 'æ­£åœ¨æµ‹è¯• AllinONE å¸‚åœº...');
            try {
                const response = await fetch(`${ALLINONE_API}/market/list`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    updateTestStatus(5, 'success', `æˆåŠŸè·å– ${data.items?.length || 0} ä¸ªç‰©å“`, data);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateTestStatus(5, 'error', error.message);
            }
        }

        function updateTestStatus(index, status, message, data) {
            testResults[index].status = status;
            testResults[index].message = message;
            if (data) testResults[index].data = data;
            renderResults();
        }

        function renderResults() {
            const container = document.getElementById('testResults');
            container.innerHTML = testResults.map((test, index) => `
                <div class="test-item ${test.status}">
                    <div class="status ${test.status}">${test.status.toUpperCase()}</div>
                    <div class="message">
                        <strong>${test.name}</strong><br>
                        ${test.message}
                    </div>
                </div>
                ${test.data ? `<div class="data-display">${JSON.stringify(test.data, null, 2)}</div>` : ''}
            `).join('');
        }

        renderResults();
    </script>
</body>
</html>
